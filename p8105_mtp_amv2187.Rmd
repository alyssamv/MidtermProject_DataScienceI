---
title: "p8105_mtp_amv2187"
author: "Alyssa Vanderbeek"
date: "26 October 2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(patchwork)

theme_set(theme_bw())
```

```{r}
accel_data = read.csv('./data/accel_data.csv') %>%
  janitor::clean_names() %>%
  gather(key = minute, value = activity_level, contains('activity')) %>%
  mutate(minute = as.integer(str_sub(minute, 10)),
         day = fct_relevel(day, 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'),
         hour = ceiling(minute / 60)) %>% # the device records activity units for every minute of the day, so we can break this up into hours of the day, starting at midnight
  arrange(week, day)

str(accel_data)

# total activity counts for each day by week
agg_days = accel_data %>%
  group_by(week, day) %>% # group by week and day
  summarise(total_activity = sum(activity_level)) %>% # get total activity for each day
  ungroup %>%
  mutate(order = row_number()) # order variable to plot later

str(agg_days)

# total activity counts by hour for each week and day
agg_hour = accel_data %>%
  group_by(week, day, hour) %>% # group by week, day, and hour
  summarise(total_activity_hr = sum(activity_level)) %>% # get total activity for each hour of every day
  ungroup %>%
  mutate(order = row_number()) # order variable to plot later

str(agg_hour)

```

## Data overview

Here I examine activity levels of a 63-year-old man over the course of several months (47 weeks). The individual has a BMI of 25, and was admitted to the CUMC Advanced Cardiac Care Center for congestive heart failure before participating in this study. The goal of the research is to understand whether activity level changes over time after a major cardiac event, and whether there is potential to gather information about health events from the data surrounding them.

The dataset is comprised of information over 47 weeks (329 days), with information being collected every minute of every day. The resulting dataset is the quite large, with `r nrow(accel_data)` data points. This information is grouped by week and day of the week, and the minute of the day. 

Activity level is measured in voltage by the device, where higher voltage counts indicate higher levels of activity. Of note, there was no missing data per se, but we can understand an activity count of 1 to mean that no activity was recorded in that minute; either the participant was not active or not wearing the device. For example, an entire day of recorded 1 values can be understood as a day on which the man did not wear the device. There were `r agg_days %>% filter(total_activity == 1440) %>% count` such days recorded. 



## Exploratory analysis - understanding the data

Upon receiving and tidying the data, I looked at the distribution of activity level and the relationship between activity level and time. There are seemingly many outliers - in particular, disproportionately high minute-to-minute activity counts - in the dataset. In other words, the distribution was highly skewed. Taking the log of the minute-to-minute counts reduces the skewness. However, I am more interested in total activity over an hour or day, which have less skewed distributions.

```{r}
# # boxplot of distribution of minute-to-minute activity
# box_minute = accel_data %>%
#   ggplot(aes(x = minute/60, y = activity_level)) + 
#   geom_boxplot() +
#   labs(
#     x = 'Hour of the day',
#     y = 'Minute-to-minute activity level'
#   )
# 
# # boxplot of the log transformed minute-to-minute activity
# box_minute_log = accel_data %>%
#   ggplot(aes(x = minute/60, y = log(activity_level))) + 
#   geom_boxplot() +
#   labs(
#     x = 'Hour of the day',
#     y = 'Minute-to-minute activity (log transform)'
#   )
# 
# # density of total daily activity - less skewed
# box_daily = agg_days %>%
#   ggplot(aes(x = total_activity)) + 
#   geom_density() +
#   labs(
#     x = 'Daily activity level',
#     y = 'Density'
#   )
# 
# (box_minute + box_minute_log) / box_daily

```


### Total daily activity over time



```{r}
# scatterplot of minute-to-minute activity level by day of the week across all weeks
# accel_data %>%
# #    filter(week == 47) %>%
#     ggplot(aes(x = minute/60, y = activity_level)) +
#     facet_grid(day ~ .) +
#     geom_point(alpha = 0.3) +
#     labs(
#       x = 'Hour of day',
#       y = 'Activity level'
#     )


```

We are interested to know whether the man's activity levels increased over time. To do this, we can fit a linear model with the day (1 to 329) as the predictor, and look at the significance of the coefficient. With a p-value <0.0001 for a positive coefficient, we can conclude that activity level did indeed increase over the course of the observed months (Figure 1).

```{r}
# linear model to test whether activity changed over time. Significant positive slope says activity increased; significant negative intercept says acitvity decreased. Lack of significance fails to reject the null hypothesis that day over the course of the months of wear does not predict activity level.
summary(lm(agg_days$total_activity ~ agg_days$order))

# scatter plot of total activity by day
agg_days %>%
  ggplot(aes(x = order, y = total_activity)) +
  geom_point() + 
  geom_smooth(method = 'lm', se = F)  +
  labs(
    title = 'Daily activity level over time',
    y = 'Total activity level',
    x = 'Time (days)',
    caption = 'Figure 1'
  )
```

Since we also have informatin on the day of the week, we can test the hypothesis that day of the week can also predict activity level. However, an ANOVA test suggests that there is little evidence to suggest a correlation; that is, that the average activity level varies by day of the week (Figure 2a). This holds true when accounting for time (Figure 2b), but note the time itself remained a significant predictor of activity level.

```{r}
# ANOVA testing relationship between activity level and day of the week
anova(lm(agg_days$total_activity ~ agg_days$day)) # ANOVA test of difference between means

# boxplot of total daily activity by day of the week
boxplot_dow = agg_days %>%
  ggplot(aes(x = day, y = total_activity, fill = day)) +
  geom_boxplot() +
  labs(
    title = 'Daily activity level by day of the week',
    x = 'Day of the week',
    y = "Total activity level",
    caption = 'Figure 2a'
  ) + 
  theme(legend.position = 'none',
        title = element_text(size = 9),
        axis.text.x = element_text(angle = 60, hjust = 1)) +
  viridis::scale_fill_viridis(
    discrete = T
  )

# ANOVA testing relationship between activity level and day of the week over time
anova(lm(agg_days$total_activity ~ agg_days$day + agg_days$order)) # ANOVA test of difference between means

# linear fit for total daily activity by day of the week
scatter_dow_time = agg_days %>%
  ggplot(aes(x = order, y = total_activity, color = day)) +
  geom_point() +
  geom_smooth(method = 'lm', se = F) +
  labs(
    title = "Daily activity level by day of the week over time",
    x = 'Time (days)',
    y = 'Total activity level',
    caption = 'Figure 2b'
  ) +
  theme(legend.position = 'none',
        title = element_text(size = 9)) + 
  viridis::scale_color_viridis(
    name = 'Day of the week',
    discrete = T
  )

boxplot_dow + scatter_dow_time

```

### Total activity over the course of the day

I examined the distribution of activity by week, day of the week, and hour of day, and found that the participant was most active during his waking hours, between 7 am and 11 pm, approximately (Figure 1).

```{r}
# distribution of activity by hour (boxplot)
ggplot(accel_data, aes(y = activity_level, x = hour, group = hour)) +
  geom_boxplot() +
  labs(
    title = 'Activity over the course of the day (distribution)',
    x = 'Hour of day, beginning at midnight',
    y = 'Activity Level',
    caption = 'Figure 1'
  )

```

```{r}
wordcountaddin::text_stats("p8105_mtp_amv2187.Rmd")
```


